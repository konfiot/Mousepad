<!DOCTYPE html>
<html lang="en">
    
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="author" content="">
        <title>Off Canvas Template for Bootstrap</title>
        <!-- Bootstrap core CSS -->
        <link href="../../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="../../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
        <link href="../../bower_components/nprogress/nprogress.css" rel="stylesheet" />
        <link href="../../bower_components/alertify.js/themes/alertify.default.css" rel="stylesheet">
        <link href="../../bower_components/alertify.js/themes/alertify.core.css" rel="stylesheet">

        <!-- Custom styles for this template -->
        <style>
            body {
                padding-top: 70px;
            }
            footer {
                padding-left: 15px;
                padding-right: 15px;
            }
            html{ overflow-y: scroll; }
            
            .tree {
                -webkit-border-radius:4px;
                -moz-border-radius:4px;
                border-radius:4px;
                -webkit-box-shadow:inset 0 1px 1px rgba(0, 0, 0, 0.05);
                -moz-box-shadow:inset 0 1px 1px rgba(0, 0, 0, 0.05);
                box-shadow:inset 0 1px 1px rgba(0, 0, 0, 0.05);
                background-color:#fbfbfb;
                border:1px solid #999;
                margin-bottom:10px;
                max-height:300px;
                min-height:20px;
                overflow-y:auto;
                padding:19px
            }
            .tree a {
                display:inline;
                overflow:hidden;
                text-overflow:ellipsis;
                width:90%
            }
            .tree li {
                list-style-type:none;
                margin:0;
                padding:4px 0 0 2px;
                position:relative
            }
            .tree li::before, .tree li::after {
                content:'';
                left:-20px;
                position:absolute;
                right:auto
            }
            .tree li::before {
                border-left:1px solid #999;
                bottom:50px;
                height:100%;
                top:0;
                width:1px;
                -webkit-transition:"border-color 0.1s ease 0.1s";
                -moz-transition:"border-color 0.1s ease 0.1s";
                -o-transition:"border-color 0.1s ease 0.1s";
                transition:"border-color 0.1s ease 0.1s"
            }
            .tree li::after {
                border-top:1px solid #999;
                height:20px;
                top:13px;
                width:23px;
                -webkit-transition:"border-color 0.1s ease 0.1s";
                -moz-transition:"border-color 0.1s ease 0.1s";
                -o-transition:"border-color 0.1s ease 0.1s";
                transition:"border-color 0.1s ease 0.1s"
            }
            .tree li label>span {
                -moz-border-radius:5px;
                -webkit-border-radius:5px;
                border:1px solid #999;
                border-radius:5px;
                display:inline-block;
                line-height:14px;
                padding:2px 4px;
                text-decoration:none;
                -webkit-transition:color .2s ease .1s, background-color .2s ease .1s, border-color .3s ease .2s;
                -moz-transition:color .2s ease .1s, background-color .2s ease .1s, border-color .3s ease .2s;
                -o-transition:color .2s ease .1s, background-color .2s ease .1s, border-color .3s ease .2s;
                transition:color .2s ease .1s, background-color .2s ease .1s, border-color .3s ease .2s
            }
            .tree li.parent_li>label>span {
                cursor:pointer
            }

            .tree li:last-child::before {
                height:30px
            }
            .tree>ul>li::before, .tree>ul>li::after {
                border:0
            }
            input:checked + span {
                background-color: grey;
            }
            .actionbar {
                border-bottom: none;
                border-left: none;
                border-right: none;
                border-top-left-radius: 0;
                border-top-right-radius: 0;
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
            }
            
            img {
                width: 100%;
            }
            
        </style>
    </head>
    
    <body>
        <div class="navbar navbar-fixed-top navbar-inverse" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand">Mousepad</a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li class="active"><a href="#">List</a></li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Recently used<b class="caret"></b></a>
                            <ul id="last_viewed" class="dropdown-menu">
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Most used<b class="caret"></b></a>
                            <ul id="most_viewed" class="dropdown-menu">
                            </ul>
                        </li>
                    </ul>
                    <form class="navbar-form navbar-left" role="search">
                        <div class="form-group">
                            <input type="text" class="form-control" id="search" placeholder="Search">
                        </div>
                    </form>
                    <ul class="nav navbar-nav navbar-right">
                        <li class="dropdown">
                                <a id="dLabel" role="button" data-toggle="dropdown" data-target="#" href="/page.html"><i class="icon-plus"></i></a>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                                    <li>
                                        <a href="edit.html#note">Note</a>
                                    </li>
                                    <li>
                                        <a href="edit.html#reminder">Reminder</a>
                                    </li>
                                    <li>
                                        <a href="edit.html#checklist">Checklist</a>
                                    </li>
                                    <li>
                                        <a href="edit.html#sketch">Sketch</a>
                                    </li>
                                </ul>
                        </li>
                        <li><a href="#"><i class="icon-cog"></i></a></li>
                        <li><a onclick="logout();" href="#"><i class="icon-signout"></i></a></li>
                    </ul>
                </div>
                <!-- /.nav-collapse -->
            </div>
            <!-- /.container -->
        </div>
        <!-- /.navbar -->
        <div class="container">
            <div class="row row-offcanvas row-offcanvas-right">
                <div class="col-md-3 sidebar-offcanvas" id="sidebar" role="navigation">
                    <div class="well sidebar-nav">
                        <ul class="nav" id="tags">
                        </ul>
                    </div>
                    <!--/.well -->
                </div>
                <!--/span-->
                <div class="col-md-9">
                    <div class="row">
                        <div class="col-md-12">
                            <ol id="path" class="breadcrumb">
                            </ol>
                        </div>
                    </div>
                    <div class="row" id="list">
                    </div>
                    <!--/row-->
                </div>
                <!--/span-->
            </div>
            <!--/row-->
            <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div id="modalcontent" class="modal-content">
                        <div id="qrcode" style="text-align:center" class="modal-body"></div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
            <!-- Modal -->
            <div class="modal fade" id="delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
            aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">Sure ?</h4>
                        </div>
                        <div class="modal-body">Are you sure to delete this note</div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" onclick="trash()" data-dismiss="modal" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
            <!-- Modal -->
            <div class="modal fade" id="dir" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
            aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">Choose a name (Has to be awesome)</h4>
                        </div>
                        <div class="modal-body" style="padding-bottom: 0;"><form class="form-horizontal"><div class="form-group"><label class="col-lg-2 control-label" for="dirname">Name : </label><div class="col-lg-10"><input name="dirname" id="dirname" type="text" class="form-control"/></div></div></form></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" onclick="create_dir()" data-dismiss="modal" class="btn btn-primary">Create</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
            <!-- Modal -->
            <div class="modal fade" id="cd" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
            aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">Where do you want to put your note ?</h4>
                        </div>
                        <div id="cdlist" class="modal-body">
                            
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="button" onclick="change_dir()" data-dismiss="modal" class="btn btn-primary">Move</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
  </div><!--/.container-->
        <!-- Bootstrap core JavaScript==================================================-
        ->
    <!-- Placed at the end of the document so the pages load faster -->
        <script src="../../bower_components/jquery/jquery.min.js"></script>
        <script src="../../bower_components/jquery.cookie/jquery.cookie.js"></script>
        <script src="../../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="../../bower_components/jquery-qrcode/jquery.qrcode.min.js"></script>
        <script src="../../bower_components/nprogress/nprogress.js"></script>
        <script src="../../bower_components/alertify.js/lib/alertify.min.js"></script>

        <script>
        var list, to_delete, list_all, to_create, to_change;
        
        function qrcode(id){
            $("#modal").modal("show");
            $("#qrcode").html("");
            $('#modal').on('shown.bs.modal', function () {
                $('#qrcode').qrcode({text: "http://mousepad.konfiot.c9.io/static/html/edit.html#" + id, width: parseInt($("#modalcontent").width()-50), height: parseInt($("#modalcontent").width()-50)});
                $("#modal").unbind('shown.bs.modal');
            });
        }
        
        function refresh_filters(){
            var tags = [], types = [], timestamps = [], dates_to_display = [false, false, false, false, false];
            
            for (var i in list){
                timestamps.push(list[i]["last_viewed"]);
                for (var j in list[i]["tags"]){
                    if ((tags.indexOf(list[i]["tags"][j]) === -1) && (list[i]["tags"][j] !== "")){
                        tags.push(list[i]["tags"][j]);
                    }
                }
                
                if ((types.indexOf(list[i]["type"]) === -1) && (list[i]["type"] !== "")){
                        types.push(list[i]["type"]);
                }
            }
            
            for (var i in list){
                if (list[i]["last_viewed"] - Math.round(new Date().getTime() / 1000) >= Math.round(new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate()).getTime() / 1000) - Math.round(new Date().getTime() / 1000)){
                    dates_to_display[0] = true;
                } else if (list[i]["last_viewed"] - (Math.round(new Date().getTime() / 1000)) >= Math.round(new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate()-1).getTime() / 1000) - Math.round(new Date().getTime() / 1000)){
                    dates_to_display[1] = true;
                } else if (list[i]["last_viewed"] - (Math.round(new Date().getTime() / 1000)) >= Math.round(new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate()- new Date().getDay()).getTime() / 1000) - Math.round(new Date().getTime() / 1000)){
                    dates_to_display[2] = true;
                } else if (list[i]["last_viewed"] - (Math.round(new Date().getTime() / 1000)) >= Math.round(new Date(new Date().getFullYear(), new Date().getMonth(), 0).getTime() / 1000) - Math.round(new Date().getTime() / 1000)){
                    dates_to_display[3] = true;
                } else if (list[i]["last_viewed"] - (Math.round(new Date().getTime() / 1000)) < Math.round(new Date(new Date().getFullYear(), new Date().getMonth(), 0).getTime() / 1000) - Math.round(new Date().getTime() / 1000)){
                    dates_to_display[4] = true;
                }
            }
            
            $("#tags").html("");
            $("#tags").append("<li><a href='#' onclick='filter_tags(\"\")'>All</a></li><li>Tags</li>");
            for (var i in tags){
                $("#tags").append("<li><a href='#' onclick=\"filter_tags('" + tags[i] + "')\">" + tags[i] + "</a></li>");
            }
            
            $("#tags").append("<li>Last edited</li>");
            
            for (var i in dates_to_display){
                if (dates_to_display[i]){
                    var date;
                    switch (i){
                        case '0' :
                            date = "Today";
                        break;
                        case '1' :
                            date = "Yesterday";
                        break;
                        case '2' :
                            date = "Last Week";
                        break;
                        case '3' :
                            date = "Last Month";
                        break;
                        case '4' :
                            date = "More than one month ago";
                        break;
                    }
                    $("#tags").append("<li><a href='#' onclick=\"filter_date(" + i + ")\">" + date + "</a></li>");
                }
            }
            
            $("#tags").append("<li>Type</li>");
            
            for (var i in types){
                $("#tags").append("<li style='text-transform: capitalize'><a href='#' onclick=\"filter_types('" + types[i] + "')\">" + types[i] + "</a></li>");
            }
        }
        
        function filter_tags(tag){
            $("#list").html("");
            var data = list;
            console.log(data);
            for (var i in data){
                if (data[i]["type"] !== "directory"){
                    if (typeof(data[i]["tags"]) === "undefined"){
                        if(tag === ""){
                            $("#list").append('<div class="col-md-4"><div class="thumbnail" style="padding: 0px ; margin-bottom: 20px;"><h4 style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden" class="caption">' + data[i]["title"] + '</h4><a href="edit.html#' + i + '" class=""><img src="http://lorempixel.com/260/260/" alt="..."></a><div class="caption" style="margin: 0; padding: 0px ;"><p class="btn-group btn-group-justified" style="margin: 0; border-left: none ; border-bottom: none;"><a class="btn btn-default btn-warning actionbar" href="#" onclick="toogle_star(\'' + i + '\')"><i id="star' + i + '" class="icon-star" style="color: ' + ((data[i]["star"]) ? "grey" : "white")  + '"></i></a><a class="btn btn-default btn-info actionbar" onclick="qrcode(\''+i+'\')" href="#"><i class="icon-qrcode"></i></a><a class="btn btn-primary btn-default actionbar" onclick="pop_change_dir_modal(\'' + i + '\')" href="#"><i class="icon-folder-close"></i></a><a onclick="pop_confirmation_modal(\'' + i + '\')" class="btn btn-default btn-danger actionbar" ><i class="icon-remove"></i></a> <a class="btn btn-default btn-success actionbar" href="#"><i class="icon-plus"></i></a></p></div></div></div>');
                        }
                    } else  if ((data[i]["tags"].indexOf(tag) !== -1) || (tag === "")){
                        $("#list").append('<div class="col-md-4"><div class="thumbnail" style="padding: 0px ; margin-bottom: 20px;"><h4 style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden" class="caption">' + data[i]["title"] + '</h4><a href="edit.html#' + i + '" class=""><img src="http://lorempixel.com/260/260/" alt="..."></a><div class="caption" style="margin: 0; padding: 0px ;"><p class="btn-group btn-group-justified" style="margin: 0; border-left: none ; border-bottom: none;"><a class="btn btn-default btn-warning actionbar" href="#" onclick="toogle_star(\'' + i + '\')"><i id="star' + i + '" class="icon-star" style="color: ' + ((data[i]["star"]) ? "grey" : "white")  + '"></i></a><a class="btn btn-default btn-info actionbar" onclick="qrcode(\''+i+'\')" href="#"><i class="icon-qrcode"></i></a><a class="btn btn-primary btn-default actionbar" onclick="pop_change_dir_modal(\'' + i + '\')" href="#"><i class="icon-folder-close"></i></a><a onclick="pop_confirmation_modal(\'' + i + '\')" class="btn btn-default btn-danger actionbar" ><i class="icon-remove"></i></a> <a class="btn btn-default btn-success actionbar" href="#"><i class="icon-plus"></i></a></p></div></div></div>');
                    }
                }
            }
        }
        
        function filter_types(type){
            $("#list").html("");
            var data = list;
            for (var i in data){
                if ((data[i]["type"] === type) || (type === "")){
                    $("#list").append('<div class="col-md-4"><div class="thumbnail" style="padding: 0px ; margin-bottom: 20px;"><h4 style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden" class="caption">' + data[i]["title"] + '</h4><a href="edit.html#' + i + '" class=""><img src="http://lorempixel.com/260/260/" alt="..."></a><div class="caption" style="margin: 0; padding: 0px ;"><p class="btn-group btn-group-justified" style="margin: 0; border-left: none ; border-bottom: none;"><a class="btn btn-default btn-warning actionbar" href="#" onclick="toogle_star(\'' + i + '\')"><i id="star' + i + '" class="icon-star" style="color: ' + ((data[i]["star"]) ? "grey" : "white")  + '"></i></a><a class="btn btn-default btn-info actionbar" onclick="qrcode(\''+i+'\')" href="#"><i class="icon-qrcode"></i></a><a class="btn btn-primary btn-default actionbar" onclick="pop_change_dir_modal(\'' + i + '\')" href="#"><i class="icon-folder-close"></i></a><a onclick="pop_confirmation_modal(\'' + i + '\')" class="btn btn-default btn-danger actionbar" ><i class="icon-remove"></i></a> <a class="btn btn-default btn-success actionbar" href="#"><i class="icon-plus"></i></a></p></div></div></div>');
                }
            }
        }
        
        function filter_date(date){
            $("#list").html("");
            var data = list;
            for (var i in data){
                var cat = -1;
                if (data[i]["last_viewed"] - Math.round(new Date().getTime() / 1000) >= Math.round(new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate()).getTime() / 1000) - Math.round(new Date().getTime() / 1000)){
                    cat = 0;
                } else if (data[i]["last_viewed"] - Math.round(new Date().getTime() / 1000) >= Math.round(new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate()-1).getTime() / 1000) - Math.round(new Date().getTime() / 1000)){
                    cat = 1;
                } else if (data[i]["last_viewed"] - Math.round(new Date().getTime() / 1000) >= Math.round(new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate()- new Date().getDay()).getTime() / 1000) - Math.round(new Date().getTime() / 1000)){
                    cat = 2;
                } else if (data[i]["last_viewed"] - Math.round(new Date().getTime() / 1000) >= Math.round(new Date(new Date().getFullYear(), new Date().getMonth(), 0).getTime() / 1000) - Math.round(new Date().getTime() / 1000)){
                    cat = 3;
                } else if (data[i]["last_viewed"] - Math.round(new Date().getTime() / 1000) < Math.round(new Date(new Date().getFullYear(), new Date().getMonth(), 0).getTime() / 1000) - Math.round(new Date().getTime() / 1000)){
                    cat = 4;
                } 
                
                if (cat === date){
                    $("#list").append('<div class="col-md-4"><div class="thumbnail" style="padding: 0px ; margin-bottom: 20px;"><h4 style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden" class="caption">' + data[i]["title"] + '</h4><a href="edit.html#' + i + '" class=""><img src="http://lorempixel.com/260/260/" alt="..."></a><div class="caption" style="margin: 0; padding: 0px ;"><p class="btn-group btn-group-justified" style="margin: 0; border-left: none ; border-bottom: none;"><a class="btn btn-default btn-warning actionbar" href="#" onclick="toogle_star(\'' + i + '\')"><i id="star' + i + '" class="icon-star" style="color: ' + ((data[i]["star"]) ? "grey" : "white")  + '"></i></a><a class="btn btn-default btn-info actionbar" onclick="qrcode(\''+i+'\')" href="#"><i class="icon-qrcode"></i></a><a class="btn btn-primary btn-default actionbar" onclick="pop_change_dir_modal(\'' + i + '\')" href="#"><i class="icon-folder-close"></i></a><a onclick="pop_confirmation_modal(\'' + i + '\')" class="btn btn-default btn-danger actionbar" ><i class="icon-remove"></i></a> <a class="btn btn-default btn-success actionbar" href="#"><i class="icon-plus"></i></a></p></div></div></div>');
                }
            }
        }
        
        function filter_dir(dir){
            var old_list = list_all;
            list = {};
            for (var i in old_list){
                if (typeof(dir) !== "undefined"){
                    if (typeof(old_list[i].dir) !== "undefined"){
                        if (old_list[i].dir === dir && old_list[i].type !== "directory"){
                            list[i] = old_list[i];
                        }
                    } else if (old_list[i].dir !== null) {
                        if (old_list[i].dir === dir && old_list[i].type !== "directory"){
                            list[i] = old_list[i];
                        }
                    }
                } else {
                    if (typeof(old_list[i].dir) === "undefined"){
                        if(old_list[i].type !== "directory"){
                            list[i] = old_list[i];
                        }
                    } else if (old_list[i].dir === null) {
                        if (old_list[i].type !== "directory"){
                            list[i] = old_list[i];
                        }
                    }
                }
            }
            var current_dir = (typeof(dir) === "undefined") ? undefined : dir;
            $("#path").html("");
            var finished;
            do {
                finished = (typeof(current_dir) === "undefined") ? true : false;
                var output = '<li class="active dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown">' + ((typeof(current_dir) === "undefined") ? "Home" : list_all[current_dir]["title"]) + '</a><b class="caret"></b><ul  class="dropdown-menu">';
                output += '<li><a tabindex="-1" onclick="filter_dir(' + ((typeof(current_dir) === "undefined") ? '' : "\'" + current_dir + "\'") + ')" href="#' + i + '">Roll Back to this directory</a></li>';
                for (var i in list_all){
                    if(list_all[i].dir === null) list_all[i].dir = undefined;
                    if ((list_all[i].type === "directory") && (list_all[i].dir === current_dir)){
                        output += '<li><a tabindex="-1" onclick="filter_dir(\'' + i + '\')" href="#' + i + '">' + list_all[i].title + '</a></li>';
                    }
                }
                output += '<li><a tabindex="-1" onclick="pop_creation_dir_modal(\'' +  ((typeof(current_dir) === "undefined") ? "" :  current_dir) + '\')" href="#">Add a new directory</a></li>';
                output += '</ul></li>';
                $("#path").prepend(output);
                if (typeof(current_dir) !== "undefined"){
                    current_dir = (typeof(list_all[current_dir]["dir"]) === "undefined") ? undefined : list_all[current_dir]["dir"];
                }
            } while (!finished);
            refresh_filters();
            filter_tags("");
        }
        
        function pop_creation_dir_modal(id){
            $("#dir").modal('show');
            to_create = id;
        }
        
        function pop_change_dir_modal(id){
            $("#cd").modal('show');
            var tree = "";
            tree = (function(id){
                var array = [];
                var tree = ((typeof(id) === "undefined") ? '<div class="tree"><ul role="tree"><li class="parent_li" role="treeitem"><label><input style="display: none" type="radio" value="undefined" name="radio_dir"/><span>Home</span></label><ul role="group">' : '<ul role="group">');
                for (var i in list_all){
                    if(list_all[i].type === "directory"){
                        if ((typeof (list_all[i].dir) === "undefined") && (typeof(id) === "undefined")){
                            tree += '<li ' + ((typeof(id) !== "undefined") ? 'style="display: none;"' : '') + ' class="parent_li" role="treeitem"><label><input style="display: none" type="radio" value="' + i + '" name="radio_dir"/><span>' + list_all[i].title + '</span></label>';
                            tree += arguments.callee(i);
                            tree += '</li>';
                            array.push(i);
                        } else if (list_all[i].dir === id){
                            tree += '<li ' + ((typeof(id) !== "undefined") ? 'style="display: none;"' : '') + ' class="parent_li" role="treeitem"><label><input style="display: none" type="radio" value="' + i + '" name="radio_dir"/><span>' + list_all[i].title + '</span></label>';
                            tree += arguments.callee(i);
                            tree += '</li>';
                            array.push(i);
                        }
                    }
                }
                tree += ((typeof(id) === "undefined") ? '</ul></li></ul></div>' : '</ul>');
                if(array.join("") === ""){
                    return "";
                } else {
                    return tree;
                }
            })();
            $("#cdlist").html(tree);
            $('.tree li:has(ul)').addClass('parent_li').find(' > span').attr('title', 'Collapse this branch');
            $('.tree li.parent_li > label > span').on('click', function(e) {
                var children = $(this).parent().parent('li.parent_li').find(' > ul > li');
                if (children.is(":visible")) {
                    children.hide('fast');
                    $(this).attr('title', 'Expand this branch').find(' > i').addClass('icon-plus-sign').removeClass('icon-minus-sign');
                }
                else {
                    children.show('fast');
                    $(this).attr('title', 'Collapse this branch').find(' > i').addClass('icon-minus-sign').removeClass('icon-plus-sign');
                }
                e.stopPropagation();
            });
            to_change = id;
        }
        
        function change_dir(){
            var val = (($("input:radio[name='radio_dir']:checked").val() === "undefined") ? "" : $("input:radio[name='radio_dir']:checked").val());
            $.post("/app/api/mod.php", {data: JSON.stringify({id: to_change, dir: val})}, function(data){}, "json");
            to_change="";
            init();
        }
        
        function toogle_star(id){
            var star;
            if (list[id]["star"] === true){
                list[id]["star"] = false;
                star = false;
                $("#star" + id).css("color", "white");
            } else {
                list[id]["star"] = true;
                star = true;
                $("#star" + id).css("color", "grey");
            }
            $.post("/app/api/mod.php", {data: JSON.stringify({id: id, star: star})}, function(data){}, "json");

        }
        
        function pop_confirmation_modal(id){
            $("#delete").modal('show');
            to_delete = id;
        }
        
        
        function init(){
            $.post("/app/api/list.php", function(data){
                list_all = data;
                filter_dir();
                refresh_shortcuts();
                $("#search").bind("input", function(){
                    $("#list").html("");
                    for (var i in list){
                        if (list[i]["title"].search($("#search").val()) !== -1){
                            $("#list").append('<div class="col-md-4"><div class="thumbnail" style="padding: 0px ; margin-bottom: 20px;"><h4 style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden" class="caption">' + data[i]["title"] + '</h4><a href="edit.html#' + i + '" class=""><img src="http://lorempixel.com/260/260/" alt="..."></a><div class="caption" style="margin: 0; padding: 0px ;"><p class="btn-group btn-group-justified" style="margin: 0; border-left: none ; border-bottom: none;"><a class="btn btn-default btn-warning actionbar" href="#" onclick="toogle_star(\'' + i + '\')"><i id="star' + i + '" class="icon-star" style="color: ' + ((data[i]["star"]) ? "grey" : "white")  + '"></i></a><a class="btn btn-default btn-info actionbar" onclick="qrcode(\''+i+'\')" href="#"><i class="icon-qrcode"></i></a><a class="btn btn-primary btn-default actionbar" onclick="pop_change_dir_modal(\'' + i + '\')" href="#"><i class="icon-folder-close"></i></a><a onclick="pop_confirmation_modal(\'' + i + '\')" class="btn btn-default btn-danger actionbar" ><i class="icon-remove"></i></a> <a class="btn btn-default btn-success actionbar" href="#"><i class="icon-plus"></i></a></p></div></div></div>');
                        }
                    }
                });
            }, "json");
        }
        
        function trash(){
            $.post("/app/api/remove.php", {data: JSON.stringify({id: to_delete})}, function(data){
                init();
            }, "json");
            to_delete = "";
        }
        
        function create_dir(){
            $.post("/app/api/add.php", {data: JSON.stringify({type: "directory", dir: ((to_create === '') ? undefined : to_create), title: $("#dirname").val()})}, function(data){
                init();
            }, "json");
            ("#dirname").val("");
            to_create = "";
        }
        
        function refresh_shortcuts(){
            var max_keys = [], max_keys_last = [], max_val = 0, max_key, max_val_last = 0, max_key_last;
            for (var i = 0 ; i < 5 ; i++){
                for (var j in list){
                    if ((list[j]["times_viewed"] > max_val) && (max_keys.indexOf(j) === -1)){
                        max_key = j;
                        max_val = list[j]["times_viewed"];
                    }
                    
                    if ((list[j]["last_viewed"] > max_val_last) && (max_keys_last.indexOf(j) === -1)){
                        max_key_last = j;
                        max_val_last = list[j]["last_viewed"];
                    }
                }
                
                if(max_key !== max_keys[max_keys.length-1]){
                    max_keys.push(max_key);
                }
                max_val = 0;
                
                if(max_key_last !== max_keys_last[max_keys_last.length-1]){
                    max_keys_last.push(max_key_last);
                }
                max_val_last = 0;
            }

            $("#most_viewed").html("");
            $("#last_viewed").html("");
            
            for (var i in max_keys){
                $("#most_viewed").append("<li><a href='edit.html#" + max_keys[i] + "'>" + list[max_keys[i]]["title"] + "</a></li>");
            }
            

            for (var i in max_keys_last){
                $("#last_viewed").append("<li><a href='edit.html#" + max_keys_last[i] + "'>" + list[max_keys_last[i]]["title"] + "</a></li>");
            }
            
        }
        
        function logout(){
            $.post("/app/api/logout.php", function(data){
                document.location.href = '/';
            }, "json");
        }
        
        $(function(){
            init();
        });
        
        $(document).ajaxStart(function() {
            NProgress.start();
        });
        $(document).ajaxStop(function() {
            NProgress.done();
        });
        $(document).ajaxError(function() {
            alertify.error("Server error, try again or report it");
        });
        $(document).ajaxSuccess(function(event, xhr) {
            var json = JSON.parse(xhr.responseText);
            if (typeof(json["error"]) !== "undefined"){
                alertify.error("Error : " + json["error"]);
                document.location.href = '/';
            }
        });
        </script>
    </body>

</html>
